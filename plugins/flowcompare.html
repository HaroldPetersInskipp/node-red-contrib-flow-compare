<script type="text/javascript">
(function() {
   var globalYourConfigNode = null;

   function escapeHtml(string) {
  return String(string).replace(/[&<>"'`=\/]/g, function fromEntityMap(s) {
    return entityMap[s];
  });
}

function loadScript(url, callback) {
  var script = document.createElement("script")
  script.type = "text/javascript";

  if (script.readyState) {  // only required for IE <9
    script.onreadystatechange = function () {
      if (script.readyState === "loaded" || script.readyState === "complete") {
        script.onreadystatechange = null;
        if (callback) { callback(); }
      }
    };
  } else {  //Others
    script.onload = function () {
      if (callback) { callback(); }
    };
  }

  script.src = url;
  document.getElementsByTagName("head")[0].appendChild(script);
};

function addPanZoom() {
  var svg = $(".flowviewer svg");

  svg.attr('width', '');
  svg.attr('height', '');
  svg.css('width', $('.flowviewer').width() + "px");
  svg.css('height', "300px");

  var bbx = $(".flowviewer svg .containerGroup")[0].getBBox();
  svg.attr('viewBox', [bbx.x, bbx.y, bbx.width, bbx.height].join(" "))

  /* this is d3 for version 3 of d3 - this is not the same as other d3 versions */
  var svg = d3.select(".flowviewer svg");
  svg.html('<g>' + svg.html() + '</g>');
  
  var inner = svg.select('g');
  var zoom = d3.behavior.zoom()
    .scaleExtent([0.3, 100])
    .on('zoom', function (event) {
      inner.attr({
        transform: "translate(" + (zoom.translate()) + ") scale(" + (zoom.scale()) + ")"
      });
    });

  svg.call(zoom);
}

var entityMap = {
  '&': '&amp;',
  '<': '&lt;',
  '>': '&gt;',
  '"': '&quot;',
  "'": '&#39;',
  '/': '&#x2F;',
  '`': '&#x60;',
  '=': '&#x3D;'
};

var descMap = {
  'z': "Flow Tab Id",
  'g': "Group Id",
  'd': "Disabled",
  'w': "Width",
  "h": "Height",
};

function attrDesc(nme) {
  return descMap[nme] ? " <i style='font-size: 80%;'>(" + descMap[nme] + ")</i>" : "";
}

function createDiff(ndeV1, ndeV2) {
  var diffDetails = [];
  var changedAttrs = [];

  Object.keys(ndeV2).forEach(function (nme) {
    if (Object.keys(ndeV1).indexOf(nme) < 0) {
      var txt = typeof ndeV2[nme] == "object" ? JSON.stringify(ndeV2[nme]) : ndeV2[nme];
      diffDetails.push("<tr class='dv-removed'><th>" + nme + attrDesc(nme) + "</th><td><i>MISSING</i></td><td><code>" + escapeHtml(txt) + "</code></td></tr>")
      changedAttrs.push(nme)
    }
  });

  Object.keys(ndeV1).forEach(function (nme) {
    if (Object.keys(ndeV2).indexOf(nme) < 0) {
      var txt = typeof ndeV1[nme] == "object" ? JSON.stringify(ndeV1[nme]) : ndeV1[nme];
      diffDetails.push("<tr class='dv-added'><th>" + nme + attrDesc(nme) + "</th><td><code>" + escapeHtml(txt) + "</code></td><td><i>ADDED</i></td></tr>")
      changedAttrs.push(nme)
    }
  });

  Object.keys(ndeV1).forEach(function (nme) {
    if (Object.keys(ndeV2).indexOf(nme) > -1) {
      if (JSON.stringify(ndeV1[nme]) !== JSON.stringify(ndeV2[nme])) {
        let span = null;
        let diff = undefined;
        changedAttrs.push(nme)

        try {
          diff = Diff.diffLines(ndeV2[nme], ndeV1[nme])
        } catch (e) {
          diff = Diff.diffLines(JSON.stringify(ndeV2[nme], undefined, 1), JSON.stringify(ndeV1[nme], undefined, 1))
        }
        const fragment = document.createDocumentFragment();

        diff.forEach((part) => {
          // green for additions, red for deletions
          const color = part.added ? 'green' : part.removed ? 'red' : '#040506';

          span = document.createElement('pre');
          span.setAttribute('class', 'dv-pre-elem');
          span.style.color = color;
          span.appendChild(document.createTextNode(part.value));
          span.appendChild(document.createElement('br'));
          fragment.appendChild(span);
        });

        var row = document.createElement('tr');
        row.setAttribute('class', "dv-differ")
        var cell = document.createElement('th')
        cell.appendChild(document.createTextNode(nme))
        if (descMap[nme]) {
          var itl = document.createElement('i');
          itl.style["font-size"] = "80%"
          itl.appendChild(document.createTextNode("(" + descMap[nme] + ")"))
          cell.appendChild(itl)
        }
        row.append(cell);

        cell = document.createElement('td')
        cell.setAttribute('colspan', '2')
        cell.append(fragment)

        row.append(cell)
        diffDetails.push(row.outerHTML)
      } else {
        diffDetails.push("<tr><th>" + nme + "</th><td><code>" + escapeHtml(ndeV1[nme]) + "</code></td><td><code>" + escapeHtml(ndeV2[nme]) + "</code></td></tr>")
      }
    }
  });

  /* 
   * strange happenings, the server says that these two nodes differ but 
   * there are zero changed attributes ... hm  ... so do a diff over the
   * entire nodes.
   */
  if (changedAttrs.length == 0) {
    let span = null;
    let nme = "OBJ"
    // let diff = Diff.diffChars(JSON.stringify(ndeV2,undefined,1), JSON.stringify(ndeV1,undefined,1))
    let diff = Diff.diffJson(ndeV2, ndeV1)

    const fragment = document.createDocumentFragment();

    diff.forEach((part) => {
      // green for additions, red for deletions
      const color = part.added ? 'green' : part.removed ? 'red' : '#040506';

      span = document.createElement('pre');
      span.setAttribute('class', 'dv-pre-elem');
      span.style.color = color;
      span.appendChild(document.createTextNode(part.value));
      span.appendChild(document.createElement('br'));
      fragment.appendChild(span);
    });

    var row = document.createElement('tr');
    row.setAttribute('class', "dv-differ")
    var cell = document.createElement('th')
    cell.appendChild(document.createTextNode(nme))
    if (descMap[nme]) {
      var itl = document.createElement('i');
      itl.style["font-size"] = "80%"
      itl.appendChild(document.createTextNode("(" + descMap[nme] + ")"))
      cell.appendChild(itl)
    }
    row.append(cell);

    cell = document.createElement('td')
    cell.setAttribute('colspan', '2')
    cell.append(fragment)

    row.append(cell)

    return {
      html: row.outerHTML,
      icon: "fa-question"
    }
  }

  var visualOnlyAttributes = ['x', 'y', 'w', 'h', 'g', 'wires'];
  
  return {
    html: diffDetails.join(""),
    icon: changedAttrs.filter(d => { return visualOnlyAttributes.indexOf(d) < 0 }).length == 0 ? "fa-eye" : "fa-pencil"
  }
}

function getFlowDataFromCurrentWorkspace() {
  /******
   ** Code taken from Node-RED code base:
   **
   ** https://github.com/node-red/node-red/blob/e8ddee24a9944e57d186f02b081295c56a45b67c/packages/node_modules/%40node-red/editor-client/src/js/ui/clipboard.js#L710-L723
   **
   **/
  var activeWorkspace = RED.workspaces.active();
  var nodes = RED.nodes.groups(activeWorkspace);

  nodes = nodes.concat(RED.nodes.junctions(activeWorkspace));
  nodes = nodes.concat(RED.nodes.filterNodes({ z: activeWorkspace }));

  RED.nodes.eachConfig(function (n) {
    if (n.z === RED.workspaces.active() && n._def.hasUsers === false) {
      // Grab any config nodes scoped to this flow that don't
      // require any flow-nodes to use them
      nodes.push(n);
    }
  });

  var parentNode = RED.nodes.workspace(
    activeWorkspace
  ) || RED.nodes.subflow(activeWorkspace);

  nodes.unshift(parentNode);

  return RED.nodes.createExportableNodeSet(nodes);
}

function iframeHasBeenLoaded(elem) {
  var nodes = getFlowDataFromCurrentWorkspace();

  setTimeout(() => {
    elem.contentWindow.postMessage({
      nodes: nodes,
      msg: "renderlocalflow",
      flowid: nodes[0].id
    }, "*")
  }, 345);
}
window.iframeHasBeenLoaded = iframeHasBeenLoaded;

function doSubmission(flowdata) {

  var activeWorkspace = RED.workspaces.active();

  $($($('#svgelem .container-diff02')[0]).find('.containerGroup')[0]).find('g').html("");
  $($($('#svgelem .container-diff01')[0]).find('.containerGroup')[0]).find('g').html("");

  $.ajax({
    url: "FlowCompareCfg",
    type: "POST",
    contentType: "application/json; charset=utf-8",

    data: JSON.stringify({
      flowid: activeWorkspace,
      flowdata: flowdata || {},
      flowlabel: RED.nodes.workspace(activeWorkspace).label,
    }),

    success: function (resp) {
      var items = [];
      var nodeItemMap = {};

      if (resp.status == "failed") {
        RED.notify("Error happened, please check console", {
          type: "error",
          timeout: 2000
        });
        
        console.error( "Error in flow compare: ", resp )
        return;
      }

      renderFlow(resp.flowid, resp.nodes, $($('#svgelem .container-diff02')[0]), {
        "arrows": false,
        "gridlines": false,
        "zoom": false,
        "images": true,
        "linklines": true,
        "dllink": false,
        "labels": true,
      });

      renderFlow(resp.flowid, flowdata, $($('#svgelem .container-diff01')[0]), {
        "arrows": false,
        "gridlines": false,
        "zoom": false,
        "images": true,
        "linklines": true,
        "dllink": false,
        "labels": true,
      });

      var svg = $(".flowviewer svg");

      svg.attr('width', '');
      svg.attr('height', '');
      svg.css('width', $('.flowviewer').width() + "px");
      svg.css('height', "300px");

      var bbx = $(".flowviewer svg .containerGroup")[0].getBBox();
      svg.attr('viewBox', [bbx.x, bbx.y, bbx.width, bbx.height].join(" "))

      // addPanZoom();

      var slider = document.getElementById("node-input-compare-slider");
      slider.oninput = function () {
        $('.container-diff01').css('opacity', this.value / 100);
        $('.container-diff02').css('opacity', (100 - this.value) / 100)
      }

      resp.changes.forEach(function (nde) {
        var nId = nde.id;

        if (nde.type == "deleted") {
          nodeItemMap[nId] = {
            label: nde.oldObj.name || nde.oldObj.type,
            icon: "fa fa-times",
            class: "",
            diffcontent: createDiff({}, nde.oldObj).html,
            sublabel: nde.oldObj.type,
            selected: false,
            checkbox: false,
            children: undefined
          };

          $('.node-' + nId).addClass('deleted');
          $('.group-' + nId).addClass('deleted');

          items.push(nodeItemMap[nId]);
          return;
        }

        if (nde.type == "added") {
          nodeItemMap[nId] = {
            objid: nId,
            label: nde.newObj.name || nde.newObj.type,
            icon: "fa fa-check",
            class: "",
            diffcontent: createDiff(nde.newObj, {}).html,
            sublabel: nde.newObj.type,
            selected: false,
            checkbox: false,
            children: undefined
          };

          $('.node-' + nId).addClass('added');
          $('.group-' + nId).addClass('added');

          items.push(nodeItemMap[nId]);
          return;
        }

        if (nde.oldObj.type == "tab" || nde.oldObj.type == "group" || nde.oldObj.type == "junction") {
          var diffContent = createDiff(nde.newObj, nde.oldObj);

          nodeItemMap[nId] = {
            objid: nId,
            label: nde.oldObj.name || nde.oldObj.type,
            icon: "fa " + diffContent.icon,
            class: "",
            diffcontent: diffContent.html,
            sublabel: nde.type + " - " + nde.oldObj.type,
            selected: false,
            checkbox: false,
            children: undefined
          };

          if (diffContent.icon == "fa-eye") {
            $('.node-' + nId).addClass('moved');
            $('.group-' + nId).addClass('moved');
          }
          if (diffContent.icon == "fa-pencil") {
            $('.node-' + nId).addClass('changed');
            $('.group-' + nId).addClass('changed');
          }
          items.push(nodeItemMap[nId]);
          return;
        }

        /* 
         * Pass this point only nodes, no groups, tabs or junctions
         */
        var n = RED.nodes.node(nId);
        if (!n) {
          console.log("Node not found", nde)
        }

        var nodeDef = RED.nodes.getType(n.type);
        var label;

        if (nodeDef) {
          var l = nodeDef.label;
          label = (typeof l === "function" ? l.call(n) : l) || "";
        }

        if (!nodeDef || !label) {
          label = n.type;
        }

        var diffContent = createDiff(nde.newObj, nde.oldObj);

        nodeItemMap[n.id] = {
          node: n,
          objid: nId,
          label: label,
          icon: "fa " + diffContent.icon,
          class: "",
          diffcontent: diffContent.html,
          sublabel: nde.oldObj.type,
          selected: false,
          checkbox: false,
          children: undefined
        };

        if (diffContent.icon == "fa-eye") {
          $('.node-' + nId).addClass('moved');
          $('.group-' + nId).addClass('moved');
        }

        if (diffContent.icon == "fa-pencil") {
          $('.node-' + nId).addClass('changed');
          $('.group-' + nId).addClass('changed');
        }

        items.push(nodeItemMap[n.id]);
      });

      if (items.length == 0) {
        RED.notify("No Flow Changes", {
          type: "warning",
          timeout: 2000
        });
        
        try {
          $("#node-input-flowcompare-target-container-div").treeList('empty')
          $('#node-input-flowcompare-diffcontainer').html("")
        } catch ( ex ) { }
      } else {
        try {
          $("#node-input-flowcompare-target-container-div").treeList('empty')
        } catch ( ex ) {
          $("#node-input-flowcompare-target-container-div").css({
            width: "100%",
            height: "200px"
          }).treeList({
              multi: false
          }).on("treelistitemmouseover", function (e, item) {
            $('.node-'+item.objid).addClass('highlight')
            $('.group-' + item.objid).addClass('highlight')
          }).on("treelistitemmouseout", function (e, item) {
            $('.node-' + item.objid).removeClass('highlight')
            $('.group-' + item.objid).removeClass('highlight')
          }).on('treelistselect', function (event, item) {
            if (item.diffcontent) {
              $('#node-input-flowcompare-diffcontainer').html(item.diffcontent)
              if (item.objid) {
                RED.view.reveal(item.objid, true)
                RED.view.redraw()
              }
            } else {
              $('#node-input-flowcompare-diffcontainer').html("")
            }
          });
        }

        $("#node-input-flowcompare-target-container-div").treeList('data', items.sort((a, b) => a.icon > b.icon));
      }
    },

    error: function (jqXHR, textStatus, errorThrown) {
      if (jqXHR.status == 404) {
        RED.notify("Node has not yet been deployed, please deploy.", "error");
      } else if (jqXHR.status == 405) {
        RED.notify("Not Allowed.", "error");
      } else if (jqXHR.status == 500) {
        RED.notify(node._("common.notification.error", {
          message: node._("inject.errors.failed")
        }), "error");
      } else if (jqXHR.status == 0) {
        RED.notify(node._("common.notification.error", {
          message: node._("common.notification.errors.no-response")
        }), "error");
      } else {
        RED.notify(node._("common.notification.error", {
          message: node._("common.notification.errors.unexpected", {
            status: jqXHR.status, message: textStatus
          })
        }), "error");
      }
    }
  });
}


   function ensureYourConfigNodeExists() {
      // This function makes sure there is 1 instance of your config node is available, and that the globalYourConfigNode variable refers to it.
      // Explained in the next step of this tutorial... --> https://discourse.nodered.org/t/tutorial-create-a-sidebar-plugin-and-persist-the-data-in-a-config-node/82020

      // If we had found it previously, check if it has been deleted by the user behind our back
      if (globalYourConfigNode !== null) {
         var configNode = RED.nodes.node(globalYourConfigNode.id);
         if (configNode === null) { globalYourConfigNode = null; }
      }

      // If not found previously, let's go find it
      if (globalYourConfigNode === null) {
         var configNodes = [];
         RED.nodes.eachConfig(function(configNode) {
             if (configNode.type === 'FlowCompareCfg') { 
                 configNodes.push(configNode); 
             }
         });

         // Make sure we only have 1 config node
         while (configNodes.length > 1) {
             var configNode = configNodes.pop();
             RED.nodes.remove(configNode.id);
             RED.nodes.dirty(true);
         }

         // When we found a config node, let's use that one
         if (configNodes.length === 1) { globalYourConfigNode = configNodes[0]; }
      }

      // When it doesn't exist yet, create it if required
      if (globalYourConfigNode === null) {
         // Remark: since this config node is dynamically created (and only used in this sidebar which isn't another node), the config
         // node is in fact "unused".  But since we don't want it to appear "unused" in the "config nodes" panel, we need to set hasUsers
         // to false (see https://github.com/node-red/node-red/blob/master/CHANGELOG.md#0161-maintenance-release).
         // The hasUsers needs also to be specified in the RED.nodes.registerType statement!
         globalYourConfigNode = {
             id: RED.nodes.id(), // on the server side, this is called RED.util.generateId()
             _def: RED.nodes.getType("FlowCompareCfg"),
             type: "FlowCompareCfg",
             hasUsers: false, 
             users: [],
             name: "FlowCompare",
             label: function() { return this.name || "FlowCompare"},
             /* values and data defined by this config node */
             data: "some default value", // Default data
         }

         // Add the new config node to the collection of Node-RED nodes
         RED.nodes.add(globalYourConfigNode);

         // Make sure the "Deploy" button becomes active
         RED.nodes.dirty(true);
      }      
   }

   // Add your plugin as a new tabsheet in the right sidebar AFTER the flow editor is completely started
   var initialiseConfigNodeOnce = () => {
      RED.events.off('runtime-state', initialiseConfigNodeOnce);

      // The html content of the sidebar has been specified below as a data-template, from where it can be loaded:
      var content = $($('script[type="text/x-red"][data-template-name="FlowCompare"]').i18n().html());
    
      // Add a "Your sidebar" tabsheet to the right sidebar panel, in which this sidebar panel can be displayed
      // --> more details: https://nodered.org/docs/api/ui/sidebar/
      RED.sidebar.addTab({
         id: "FlowCompare",
         label: "Flow Compare", // short name for the tab
         name: "Flow Compare", // long name for the menu
         content: content,
         closeable: true,
         // disableOnEdit: true,
         enableOnEdit: true,
         iconClass: "fa fa-map" // your fontawesome icon
      });

      // required external libraries
      loadScript("https://cdn.openmindmap.org/thirdparty/diff.min.js", () => {
           loadScript("https://cdn.openmindmap.org/embed/flowviewer.js")
      })
      
      addPanZoom();
      ensureYourConfigNodeExists();

      $('#node-input-flowcompare-button').on('click', (e) => {
         if ( e ) { e.preventDefault(); }
         doSubmission(getFlowDataFromCurrentWorkspace())
      });
   };
   RED.events.on('runtime-state', initialiseConfigNodeOnce);
})();
</script>

<style>
.flow-description-text {
  font-family: monospace;
  font-size: 30px;
  dominant-baseline: middle;
}
.flowviewer {
  border: 1px rgb(196, 196, 196) solid;
  border-radius: 5px;
}

.deleted {
  fill: rgb(120, 68, 68);
  fill-opacity: 0.2;
  stroke: black;
  stroke-width: 2px;
}
.added {
  fill: rgb(64, 166, 98);
  fill-opacity: 0.4;
  stroke: rgb(10, 255, 23);
  stroke-width: 4px;
}
.changed {
  fill: rgb(126, 97, 208);
  fill-opacity: 0.6;
  stroke: rgb(229, 0, 156);
  stroke-width: 3px;
}
.moved {
  fill: rgb(210, 251, 89);
  fill-opacity: 0.3;
  stroke: rgb(0, 50, 249);
  stroke-width: 3px;
}

.highlight {
  stroke: rgb(255, 89, 89) !important;
  stroke-width: 10px !important;
}

.diff-viewer {
  overflow: scroll;
  background-color: rgb(244, 244, 244);
  border: 1px solid rgb(196, 196, 196);
  height: 80vh;
  padding: 20px;
  max-width: 90vw;
  border-radius: 5px;
}

.dv-differ {
  background-color: rgba(244, 170, 23, 0.476) !important;
}

.dv-removed {
  background-color: rgb(203, 203, 38) !important;
}

.dv-added {
  background-color: rgb(86, 222, 120) !important;
}

.dv-pre-elem {
  page-break-inside: avoid;
  font-family: monospace;
  max-width: 100%;
  overflow: auto;
  display: block;
  word-wrap: break-word;
  margin: 0px !important;
}


#diff-viewer{
  overflow:scroll;
  background-color:rgb(244, 244, 244);
  border: 2px solid #000;
  height:80vh;
  display:none;
  position:fixed;
  top:10vh;
  left:5vw;
  z-index: 1000;
  padding: 20px;
  max-width: 90vw;
}

.dv-differ {
  background-color: rgba(244, 170, 23, 0.476) !important;
}

.dv-removed {
  background-color: rgb(203, 203, 38) !important;
}

.dv-added {
  background-color: rgb(86, 222, 120) !important;
}

.dv-pre-elem {
    page-break-inside: avoid;
    font-family: monospace;
    max-width: 100%;
    overflow: auto;
    display: block;
    word-wrap: break-word;
    margin: 0px !important;
}

</style>

<!-- The html for the right sidebar plugin screen -->
<script type="text/x-red" data-template-name="FlowCompare">
  <div class="form-row" style="margin-left: 15px; margin-top: 30px;">
    <button id="node-input-flowcompare-button"
                class="red-ui-button">Compare Local to Server Flow</button>
  </div>
    
  <div class="form-row node-input-target-row node-input-target-list-row" style="position: relative; min-height: 100px">  
    <div id="node-input-flowcompare-target-container-div" style="min-height: 100px"></div>
  </div>
  
  <div class="form-row" style="position: relative; min-height: 300px;">
    <div id="node-input-flowcompare-svgcontainer" class="flowviewer">
      <svg id="svgelem" pointer-events="all" style="cursor: crosshair; min-height: 300px;"
        version="1.1" xmlns="http://www.w3.org/2000/svg">
        <!-- Use group elems to ensure that layering of shapes is correct, i.e. nodes always over wires -->
        <g class='container-gridlines'>
          <g class='flowGridlines'></g>
        </g>

        <g class='container-diff01' style="opacity: 0;">
          <g class="containerGroup">
            <g class="flowDescription"></g>
            <g class='flowGroups'></g>
            <g class='flowWires'></g>
            <g class='flowNodes'></g>
          </g>
        </g>
        <g class='container-diff02'  style="opacity: 1;">
          <g class="containerGroup">
            <g class="flowDescription"></g>
            <g class='flowGroups'></g>
            <g class='flowWires'></g>
            <g class='flowNodes'></g>
          </g>
        </g>
      </svg>
    </div>
    <input style="width: 100%; min-width: 300px;" id="node-input-compare-slider" type="range" min="0" max="100" step="1" value="0"></input>
  </div>
  
  <div class="form-row" style="position: relative; min-height: 100px">
    <div id="node-input-flowcompare-diffcontainer" class="diff-viewer"></div>
  </div>

</script>